{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DE-MCU 로그 모니터</title>
    <link rel="stylesheet" href="{% static 'ws_ui/tailwind.min.css' %}" />
    <link rel="stylesheet" href="{% static 'ws_ui/remixicon.full.css' %}" />
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <style>
      /* base UI tokens */
      :root{
        --bg: #f9fafb;
        --card-bg: #ffffff;
        --muted: #6b7280;
        --primary: #2563eb;
        --accent: #4f46e5;
        --row-hover: #f3f4f6;
        --stripe: #fbfdff;
        --log-highlight-bg: #fde68a;
        --log-highlight-color: #92400e;
      }

      body{background:var(--bg);}
      .card{background:var(--card-bg)}
      .muted{color:var(--muted)}
      .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .75rem;border-radius:.5rem;border:1px solid rgba(0,0,0,0.04);background:transparent}
      .btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;border:none}

      mark.log-highlight{background:var(--log-highlight-bg);color:var(--log-highlight-color);padding:0 .15rem;border-radius:3px}

      /* table improvements */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{position:sticky;top:0;z-index:10;background:var(--card-bg);backdrop-filter: blur(4px)}
      tbody tr{background:transparent}
      tbody tr:nth-child(even){background:var(--stripe)}
      tbody tr:hover{background:var(--row-hover)}
      td,th{padding:.5rem .75rem;vertical-align:top}

      /* level chips */
      .level-chip{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .45rem;border-radius:9999px;border:1px solid rgba(0,0,0,0.04);font-weight:600}
      .level-chip .count{font-weight:700;margin-left:.3rem;background:rgba(0,0,0,0.04);padding:.05rem .35rem;border-radius:999px;font-size:.75rem}

      /* Message cell truncation on small screens with expand toggle */
      .log-msg{display:block;max-height:3.6rem;overflow:hidden;text-overflow:ellipsis;white-space:pre-wrap;word-break:break-word}
      .log-msg.expanded{max-height:none}

      /* mobile layout: compact card-like rows */
      @media (max-width: 640px){
        table,thead,tbody,th,td,tr{display:block}
        thead{display:none}
        tr{margin-bottom:.75rem;border-radius:8px;padding:.5rem;border:1px solid rgba(0,0,0,0.04);background:var(--card-bg)}
        td{display:flex;padding:.4rem}
        td.label{font-size:.85rem;color:var(--muted);width:30%}
        td.value{width:70%}
      }

      /* modal styles */
      .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:50}
      .modal{background:var(--card-bg);padding:1rem;border-radius:8px;max-width:640px;width:100%;box-shadow:0 8px 30px rgba(2,6,23,0.4)}
      .modal .modal-header{font-weight:700;margin-bottom:.5rem}
      .modal .modal-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem}
      .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:transparent}
      .filter-badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;padding:.05rem .4rem;border-radius:999px;background:rgba(0,0,0,0.06);font-size:.75rem;margin-left:.35rem}
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gray-800 text-white px-6 py-4">
          <h1 class="text-xl font-bold"> Logging View Page</h1>
          <div class="flex items-center gap-4 mt-2 text-sm text-gray-300">
            {% comment %} 로그 파일 선택: 뷰에서 log_files 컨텍스트 변수로 전달하세요 (권장: 정렬 및 중복 제거) {% endcomment %}
            {% if log_files %}
              <label for="logFileSelect" class="mr-2">파일:</label>
              <select id="logFileSelect" name="log_file" class="px-2 py-1 border rounded text-sm">
                {# ifchanged 태그는 인접한 중복을 제거합니다. 뷰에서 정렬하면 전체 중복 제거 효과가 납니다. #}
                {% for f in log_files %}
                  {% ifchanged %}
                    <option value="{{ f }}">{{ f }}</option>
                  {% endifchanged %}
                {% endfor %}
              </select>
            {% else %}
              <span>파일:-</span>
            {% endif %}
            <span class="mt-2 flex items-center gap-2">
              <button id="preset1h" class="text-xs px-2 py-0.5 border rounded">1D</button>
              <button id="preset24h" class="text-xs px-2 py-0.5 border rounded">24h</button>
              <button id="preset7d" class="text-xs px-2 py-0.5 border rounded">7D</button>
              <input id="startTs" type="datetime-local" class="text-xs px-2 py-1 text-black border rounded" title="시작 시간">
              <input id="endTs" type="datetime-local" class="text-xs px-2 py-1 text-black border rounded" title="종료 시간">
              <button id="applyTsFilter" class="text-xs px-2 py-1 border rounded">적용</button>
              <button id="clearTsFilter" class="text-xs px-2 py-1 border rounded">해제</button>
            </span>
          </div>
        </div>

        <div class="p-4 border-b border-gray-200">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <button id="loadBtn" class="btn primary text-white text-sm font-medium hover:opacity-95 transition-colors">
                <i class="ri-refresh-line lg:mr-2"></i><span class="hidden lg:inline">로드</span>
              </button>
              <button id="connectBtn" class="btn bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition-colors">
                <i class="ri-wifi-line lg:mr-2"></i><span class="hidden lg:inline">연결</span>
              </button>
              <button id="disconnectBtn" class="btn bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition-colors disabled:opacity-50" disabled>
                <i class="ri-wifi-off-line lg:mr-2"></i><span class="hidden lg:inline">해제</span>
              </button>
              <button id="pauseBtn" class="btn bg-yellow-600 text-white text-sm font-medium hover:bg-yellow-700 transition-colors">
                <i class="ri-pause-line lg:mr-2"></i><span class="hidden lg:inline">정지</span>
              </button>
              <button id="resumeBtn" class="btn bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
                <i class="ri-play-line lg:mr-2"></i><span class="hidden lg:inline">재개</span>
              </button>
            </div>

            <div class="flex items-center gap-3">
              <label class="flex items-center gap-2 text-sm text-gray-600"><input id="autoReconnect" type="checkbox"><span class="hidden lg:inline"> 자동</span> 재연결</label>
              <div class="flex items-center gap-2">
                <div id="wsStatus" class="w-3 h-3 bg-red-500 rounded-full"></div>
                <span id="wsStatusText" class="text-sm text-gray-600"><span class="hidden lg:inline">WS 연결 </span>해제됨</span>
              </div>
            </div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                  <span>타임스탬프</span>
                  <span>
                    <button class="sort-asc text-xs px-2 py-0.5 border-0 border-solid" data-col="ts"><i class="ri-arrow-up-line"></i></button>
                    <button class="sort-desc text-xs px-2 py-0.5 bborder-0 border-solid" data-col="ts"><i class="ri-arrow-down-line"></i></button>
                  </span>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                  <span>레벨</span>
                  <span>
                    <button id="openLevelFilter" class="icon-btn border-0 border-solid" title="레벨 필터"><i class="ri-filter-3-line"></i></button>
                    <span id="levelSelectedCount" class="filter-badge border-0 border-solid" title="선택된 레벨 수">0</span>
                  </span>
                </th>

                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-auto">
                  <span>메시지</span>
                  <span>
                    <button id="openGeneralFilter" class="icon-btn" title="필터 열기"><i class="ri-filter-3-line"></i></button>
                    <div id="generalFilterBadge" class="filter-badge" title="필터 설정">필터</div>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody id="logTableBody" class="bg-white divide-y divide-gray-200">
            </tbody>
          </table>
        </div>

        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
          <div class="flex items-center justify-between text-sm text-gray-600">
            <span>총 <span id="totalLogs">0</span>개의 로그 항목</span>
            <span>마지막 업데이트: <span id="lastUpdate"></span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Level filter modal -->
    <div id="levelFilterModalOverlay" class="modal-overlay" role="dialog" aria-hidden="true">
      <div class="modal" role="document">
        <div class="modal-header">레벨 필터</div>
        <div class="modal-body">
          <p class="muted text-sm">표시할 로그 레벨을 다중 선택하세요.</p>
          <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
            <label><input type="checkbox" class="level-checkbox" value="ERROR"> ERROR</label>
            <label><input type="checkbox" class="level-checkbox" value="WARNING"> WARNING</label>
            <label><input type="checkbox" class="level-checkbox" value="INFO"> INFO</label>
            <label><input type="checkbox" class="level-checkbox" value="DEBUG"> DEBUG</label>
          </div>
        </div>
        <div class="modal-actions">
          <button id="levelFilterCancel" class="btn">취소</button>
          <button id="levelFilterApply" class="btn primary">적용</button>
        </div>
      </div>
    </div>

    <!-- Message filter was merged into General Filter modal below -->

    <!-- General filter modal (recent lines, poll interval, keyword, auto-poll, message filter) -->
    <div id="generalFilterModalOverlay" class="modal-overlay" role="dialog" aria-hidden="true">
      <div class="modal" role="document">
        <div class="modal-header">필터 설정</div>
        <div class="modal-body">
          <div class="grid" style="gap:.5rem">
            <label class="text-sm muted">최근 표시 라인 수</label>
            <select id="tailLinesSelect" class="px-2 py-1 border rounded text-sm" title="표시할 최근 라인 수">
              <option value="50">50줄</option>
              <option value="100">100줄</option>
              <option value="200" selected>200줄</option>
              <option value="500">500줄</option>
              <option value="1000">1000줄</option>
            </select>

            <label class="text-sm muted">폴링 간격 (ms)</label>
            <input id="pollInterval" type="number" min="500" step="100" value="5000" class="px-2 py-1 border rounded text-sm">

            <label class="text-sm muted">키워드 필터 (스페이스/콤마 구분, /regex/ 지원)</label>
            <input id="keywordFilter" class="px-2 py-1 border rounded text-sm" placeholder="예: error timeout 또는 /error.*code/">

            <!-- 메시지 필터 입력 삭제됨: 하이라이트 색상만 유지 -->
            <label class="text-sm muted" style="display:block;margin-top:.25rem">(선택) 하이라이트 색상</label>
            <input id="highlightColor" type="color" value="#fde68a" style="margin-top:.25rem">

            <label class="flex items-center gap-2 text-sm text-gray-600"><input id="autoPoll" type="checkbox"> 자동 폴링</label>
          </div>
        </div>
        <div class="modal-actions">
          <button id="generalFilterCancel" class="btn">취소</button>
          <button id="generalFilterApply" class="btn primary">적용</button>
        </div>
      </div>
    </div>

    <script src="{% static 'ws_ui/client.js' %}"></script>
    <noscript>
      <div style="color:#b91c1c;padding:1rem;text-align:center">자바스크립트가 비활성화되어 있습니다. UI의 전체 기능을 사용하려면 브라우저에서 JavaScript를 활성화하세요.</div>
    </noscript>
  </body>
</html>
